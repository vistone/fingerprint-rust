# Logstash configuration for Fingerprint API logging

input {
  # Collect logs from Kubernetes pods
  kubernetes {
    statement => "SELECT * FROM logs WHERE pod_name like 'fingerprint-api-%' AND namespace = 'fingerprint'"
  }
  
  # Alternative: Use filebeat from containers
  beats {
    port => 5044
    codec => json
  }
  
  # File input for container logs
  file {
    path => "/var/log/containers/*fingerprint-api*.log"
    start_position => "beginning"
    codec => json
    tags => ["fingerprint-api"]
  }
}

filter {
  # Ensure we have valid JSON
  if [message] {
    json {
      source => "message"
      target => "parsed"
    }
  }
  
  # Parse timestamp
  date {
    match => ["timestamp", "YYYY-MM-dd'T'HH:mm:ss.SSSZ"]
    target => "@timestamp"
  }
  
  # Add metadata
  mutate {
    add_field => {
      "service" => "fingerprint-api"
      "environment" => "%{ENVIRONMENT:production}"
      "log_version" => "1.0"
    }
  }
  
  # Parse HTTP request logs
  if "fingerprint-api" in [tags] {
    grok {
      match => {
        "message" => "%{IP:source_ip} %{DATA:user_agent:string} \"%{WORD:http_method} %{DATA:http_path} HTTP/%{NUMBER:http_version}\" %{NUMBER:status_code} %{NUMBER:response_size} %{NUMBER:response_time_ms}"
      }
      add_tag => [ "http-request" ]
      tag_on_failure => []
    }
    
    # Convert numeric fields
    mutate {
      convert => {
        "status_code" => "integer"
        "response_size" => "integer"
        "response_time_ms" => "float"
      }
    }
    
    # Add severity based on status code
    if [status_code] >= 500 {
      mutate {
        add_field => { "severity" => "ERROR" }
      }
    } else if [status_code] >= 400 {
      mutate {
        add_field => { "severity" => "WARN" }
      }
    } else {
      mutate {
        add_field => { "severity" => "INFO" }
      }
    }
  }
  
  # Parse error logs
  if "ERROR" in [message] or "Exception" in [message] {
    mutate {
      add_field => { "severity" => "ERROR" }
      add_tag => [ "error" ]
    }
  }
  
  # Parse model inference logs
  if "inference" in [message] {
    grok {
      match => {
        "message" => "inference.*family=%{DATA:predicted_family}.*version=%{DATA:predicted_version}.*confidence=%{NUMBER:confidence}"
      }
      add_tag => [ "inference" ]
      tag_on_failure => []
    }
    
    mutate {
      convert => {
        "confidence" => "float"
      }
    }
  }
  
  # Ensure all documents have required fields
  if ![severity] {
    mutate {
      add_field => { "severity" => "INFO" }
    }
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "fingerprint-api-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }
  
  # Debug output (optional)
  if [@metadata][debug] {
    stdout {
      codec => rubydebug
    }
  }
  
  # Alert on errors
  if "ERROR" in [severity] {
    email {
      host => "smtp.example.com"
      to => "alerts@example.com"
      subject => "Fingerprint API Error: %{message}"
      body => "Error detected in Fingerprint API:\n\n%{message}\n\nSeverity: %{severity}"
    }
  }
}
