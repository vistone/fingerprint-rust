name: Continuous Fuzzing

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering
  push:
    paths:
      - 'fuzz/**'
      - 'crates/**/*.rs'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  FUZZ_TIMEOUT_SECONDS: 300
  TEST_FEATURES: "rustls-tls,compression,http2,http3,connection-pool,dns"

jobs:
  fuzz:
    name: Fuzz Testing
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        fuzz_target:
          - fuzz_ja3_generation
          - fuzz_packet_parsing
          - fuzz_tls_parsing
          - fuzz_http_headers
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust nightly
      uses: dtolnay/rust-toolchain@nightly
    
    - name: Install cargo-fuzz
      run: cargo install cargo-fuzz
    
    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          fuzz/target/
        key: ${{ runner.os }}-fuzz-${{ hashFiles('fuzz/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-fuzz-
    
    - name: Run fuzzing for ${{ matrix.fuzz_target }}
      run: |
        cd fuzz
        # Run fuzzing for configured timeout
        timeout ${{ env.FUZZ_TIMEOUT_SECONDS }} cargo fuzz run ${{ matrix.fuzz_target }} -- -max_total_time=${{ env.FUZZ_TIMEOUT_SECONDS }} || true
      continue-on-error: true
    
    - name: Check for crashes
      run: |
        cd fuzz
        if [ -d "artifacts/${{ matrix.fuzz_target }}" ] && [ "$(ls -A artifacts/${{ matrix.fuzz_target }})" ]; then
          echo "::warning::Crashes found in ${{ matrix.fuzz_target }}"
          ls -lh artifacts/${{ matrix.fuzz_target }}/
          exit 1
        else
          echo "No crashes found in ${{ matrix.fuzz_target }}"
        fi
    
    - name: Upload crash artifacts
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: fuzz-artifacts-${{ matrix.fuzz_target }}
        path: fuzz/artifacts/${{ matrix.fuzz_target }}/
        retention-days: 30

  fuzz-coverage:
    name: Fuzzing Coverage Report
    runs-on: ubuntu-latest
    needs: fuzz
    if: always()
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust nightly
      uses: dtolnay/rust-toolchain@nightly
    
    - name: Install cargo-fuzz
      run: cargo install cargo-fuzz
    
    - name: Generate coverage report
      run: |
        cd fuzz
        for target in fuzz_ja3_generation fuzz_packet_parsing fuzz_tls_parsing fuzz_http_headers; do
          echo "Coverage for $target:"
          cargo fuzz coverage $target || true
        done
