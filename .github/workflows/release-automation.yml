name: Release Automation

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 2.1.0)'
        required: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================================
  # Pre-release Validation
  # ============================================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Check formatting
        run: cargo fmt --all -- --check
      
      - name: Run clippy
        run: cargo clippy --workspace --features rustls-tls,compression,http2,connection-pool,dns -- -D warnings
      
      - name: Run tests
        run: cargo test --workspace --features rustls-tls,compression,http2,connection-pool,dns
      
      - name: Build release
        run: cargo build --workspace --release --features rustls-tls,compression,http2,connection-pool,dns
      
      - name: Generate changelog
        run: |
          echo "## Release Notes" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "**Version: ${{ github.ref_name }}" >> RELEASE_NOTES.md
          echo "Date: $(date -u +'%Y-%m-%d')**" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          git log --oneline --no-decorate $(git describe --tags --abbrev=0 2>/dev/null || echo "HEAD~10")..HEAD >> RELEASE_NOTES.md 2>/dev/null || echo "First release" >> RELEASE_NOTES.md
      
      - name: Upload release notes
        uses: actions/upload-artifact@v3
        with:
          name: release-notes
          path: RELEASE_NOTES.md

  # ============================================================
  # Build Artifacts
  # ============================================================
  build:
    name: Build (${{ matrix.os }})
    needs: validate
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: fingerprint-linux-x86_64.tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: fingerprint-windows-x86_64.zip
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: fingerprint-macos-x86_64.tar.gz
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Cache cargo
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-build-
      
      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}
      
      - name: Create artifact (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p release-artifacts
          tar -czf release-artifacts/${{ matrix.artifact }} -C target/${{ matrix.target }}/release fingerprint-gateway fingerprint
          ls -la release-artifacts/
      
      - name: Create artifact (Windows)
        if: runner.os == 'Windows'
        run: |
          mkdir release-artifacts
          powershell Compress-Archive -Path target/${{ matrix.target }}/release/*.exe -DestinationPath release-artifacts/${{ matrix.artifact }}
          dir release-artifacts\
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: binaries-${{ matrix.os }}
          path: release-artifacts/

  # ============================================================
  # Publish to Crates.io
  # ============================================================
  publish:
    name: Publish Crates
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Publish core crates
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_TOKEN }}
        run: |
          # Publish in dependency order
          cargo publish --manifest-path crates/fingerprint-core/Cargo.toml --allow-dirty --token ${{ secrets.CARGO_TOKEN }} || true
          sleep 10
          cargo publish --manifest-path crates/fingerprint-tls/Cargo.toml --allow-dirty --token ${{ secrets.CARGO_TOKEN }} || true
          sleep 10
          cargo publish --manifest-path crates/fingerprint-profiles/Cargo.toml --allow-dirty --token ${{ secrets.CARGO_TOKEN }} || true
          sleep 10
          cargo publish --manifest-path crates/fingerprint-headers/Cargo.toml --allow-dirty --token ${{ secrets.CARGO_TOKEN }} || true
          sleep 10
          cargo publish --manifest-path crates/fingerprint-http/Cargo.toml --allow-dirty --token ${{ secrets.CARGO_TOKEN }} || true
          sleep 10
          cargo publish --manifest-path crates/fingerprint/Cargo.toml --allow-dirty --token ${{ secrets.CARGO_TOKEN }} || true

  # ============================================================
  # Create GitHub Release
  # ============================================================
  create-release:
    name: Create GitHub Release
    needs: [build, publish]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v3
      
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            binaries-*/*/fingerprint-*.tar.gz
            binaries-*/*/fingerprint-*.zip
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # Post-release Updates
  # ============================================================
  post-release:
    name: Post-Release Updates
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true
      
      - name: Update version in main branch
        run: |
          git config --global user.email "release-bot@fingerprint-rust.io"
          git config --global user.name "Release Bot"
          
          # Extract version number
          VERSION="${{ github.ref_name }}"
          VERSION=${VERSION#v}
          
          # Update Cargo.toml version
          sed -i "s/^version = .*/version = \"$VERSION\"/" Cargo.toml
          
          # Commit and push
          if git diff --quiet; then
            echo "No changes needed"
          else
            git add Cargo.toml
            git commit -m "chore: bump version to $VERSION"
            git push
          fi

  # ============================================================
  # Notification
  # ============================================================
  notify:
    name: Release Notification
    needs: [create-release]
    runs-on: ubuntu-latest
    steps:
      - name: Send notification
        run: |
          echo "ðŸŽ‰ Release ${{ github.ref_name }} completed successfully!"
          echo ""
          echo "âœ… All checks passed"
          echo "âœ… Artifacts built for Linux, Windows, macOS"
          echo "âœ… Published to crates.io"
          echo "âœ… GitHub Release created"
